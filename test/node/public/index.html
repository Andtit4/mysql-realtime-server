<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users — API + Realtime</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 1rem auto; padding: 0 1rem; }
    h1 { font-size: 1.5rem; }
    .status { padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; }
    .status.connected { background: #d4edda; color: #155724; }
    .status.disconnected { background: #f8d7da; color: #721c24; }
    .status.connecting { background: #fff3cd; color: #856404; }
    form { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    form input { padding: 0.5rem; flex: 1; min-width: 120px; }
    form button { padding: 0.5rem 1rem; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f5f5f5; }
    .actions { display: flex; gap: 0.25rem; }
    .actions button { padding: 0.25rem 0.5rem; font-size: 12px; cursor: pointer; }
    .edit-row input { width: 100%; padding: 0.25rem; }
    .error { color: #c00; font-size: 12px; margin-top: 0.25rem; }
    #log { background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 6px; font-family: monospace; font-size: 11px; max-height: 160px; overflow-y: auto; }
    #log .event { margin: 0.15rem 0; }
    #log .insert { color: #4ec9b0; }
    #log .update { color: #dcdcaa; }
    #log .delete { color: #f48771; }
  </style>
</head>
<body>
  <h1>Users — API Express + Realtime</h1>
  <div id="status" class="status disconnected">Déconnecté</div>

  <form id="form-add">
    <input type="text" name="name" placeholder="Nom" required>
    <input type="email" name="email" placeholder="Email" required>
    <button type="submit">Ajouter</button>
  </form>
  <div id="error" class="error"></div>

  <h2>Liste des users</h2>
  <table>
    <thead>
      <tr><th>Id</th><th>Nom</th><th>Email</th><th>Actions</th></tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <h3>Événements temps réel</h3>
  <div id="log"></div>

  <script>
    const API_BASE = ''; // même origine (servi par Express)
    const REALTIME_PORT = 3040;
    const wsUrl = `ws://${location.hostname}:${REALTIME_PORT}/realtime`;

    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const logEl = document.getElementById('log');
    const errorEl = document.getElementById('error');
    let ws = null;
    let users = [];

    function setStatus(className, text) {
      statusEl.className = 'status ' + className;
      statusEl.textContent = text;
    }

    function addLog(type, data) {
      const time = new Date().toLocaleTimeString('fr-FR');
      const div = document.createElement('div');
      div.className = 'event ' + type;
      div.textContent = `[${time}] ${type}: ${JSON.stringify(data)}`;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function renderList() {
      listEl.innerHTML = users
        .map((u) => {
          if (u._editing) {
            return `<tr data-id="${u.id}">
              <td>${u.id}</td>
              <td><input class="edit-name" value="${escapeHtml(u.name)}"></td>
              <td><input class="edit-email" value="${escapeHtml(u.email)}" type="email"></td>
              <td class="actions">
                <button type="button" class="save-edit">Enregistrer</button>
                <button type="button" class="cancel-edit">Annuler</button>
              </td>
            </tr>`;
          }
          return `<tr data-id="${u.id}">
            <td>${u.id}</td>
            <td>${escapeHtml(u.name)}</td>
            <td>${escapeHtml(u.email)}</td>
            <td class="actions">
              <button type="button" class="btn-edit">Modifier</button>
              <button type="button" class="btn-delete">Supprimer</button>
            </td>
          </tr>`;
        })
        .join('');

      listEl.querySelectorAll('.btn-delete').forEach((btn) => {
        btn.onclick = () => deleteUser(Number(btn.closest('tr').dataset.id));
      });
      listEl.querySelectorAll('.btn-edit').forEach((btn) => {
        btn.onclick = () => {
          const id = Number(btn.closest('tr').dataset.id);
          users = users.map((u) => (u.id === id ? { ...u, _editing: true } : u));
          renderList();
        };
      });
      listEl.querySelectorAll('.save-edit').forEach((btn) => {
        btn.onclick = () => {
          const row = btn.closest('tr');
          const id = Number(row.dataset.id);
          const name = row.querySelector('.edit-name').value.trim();
          const email = row.querySelector('.edit-email').value.trim();
          if (!name || !email) return;
          updateUser(id, { name, email });
          users = users.map((u) => (u.id === id ? { ...u, name, email, _editing: false } : u));
          renderList();
        };
      });
      listEl.querySelectorAll('.cancel-edit').forEach((btn) => {
        btn.onclick = () => {
          const id = Number(btn.closest('tr').dataset.id);
          users = users.map((u) => (u.id === id ? { ...u, _editing: false } : u));
          renderList();
        };
      });
    }

    async function loadUsers() {
      try {
        const res = await fetch(API_BASE + '/api/users');
        if (!res.ok) throw new Error(res.statusText);
        users = await res.json();
        renderList();
      } catch (err) {
        errorEl.textContent = 'Erreur chargement: ' + err.message;
      }
    }

    async function addUser(name, email) {
      errorEl.textContent = '';
      try {
        const res = await fetch(API_BASE + '/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    async function updateUser(id, { name, email }) {
      errorEl.textContent = '';
      try {
        const res = await fetch(API_BASE + '/api/users/' + id, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    async function deleteUser(id) {
      errorEl.textContent = '';
      try {
        const res = await fetch(API_BASE + '/api/users/' + id, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || res.statusText);
        }
        addLog('delete', { id });
        users = users.filter((u) => u.id !== id);
        renderList();
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    document.getElementById('form-add').onsubmit = (e) => {
      e.preventDefault();
      const name = e.target.name.value.trim();
      const email = e.target.email.value.trim();
      if (!name || !email) return;
      addUser(name, email);
      e.target.name.value = '';
      e.target.email.value = '';
    };

    function connectWs() {
      if (ws?.readyState === WebSocket.OPEN) return;
      setStatus('connecting', 'Connexion WebSocket…');
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        setStatus('connected', 'Connecté (API + temps réel)');
        ws.send(JSON.stringify({ action: 'subscribe', table: 'users', pattern: 'users' }));
      };

      ws.onmessage = (e) => {
        try {
          const payload = JSON.parse(e.data);
          addLog(payload.type, payload.type === 'update' ? payload.current : payload.data);

          if (payload.type === 'insert') {
            const d = payload.data;
            if (d && !users.some((u) => u.id === d.id)) {
              users.push({ id: d.id, name: d.name, email: d.email });
              renderList();
            }
          } else if (payload.type === 'update') {
            const d = payload.current;
            if (d) {
              const i = users.findIndex((u) => u.id === d.id);
              if (i >= 0) {
                users[i] = { ...users[i], name: d.name, email: d.email };
                renderList();
              }
            }
          } else if (payload.type === 'delete') {
            const d = payload.data;
            const id = d?.id != null ? Number(d.id) : null;
            if (id != null) {
              users = users.filter((u) => u.id !== id);
              renderList();
            }
          }
        } catch (err) {
          addLog('error', e.data);
        }
      };

      ws.onclose = () => setStatus('disconnected', 'Déconnecté');
      ws.onerror = () => setStatus('disconnected', 'Erreur WebSocket');
    }

    loadUsers();
    connectWs();
  </script>
</body>
</html>
